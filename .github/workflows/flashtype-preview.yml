name: Flashtype Preview

# Requires secrets:
# - CLOUDFLARE_ACCOUNT_ID: Cloudflare account ID for the worker.
# - CLOUDFLARE_API_TOKEN: Token with Workers Scripts Edit + Workers KV Storage Edit (if needed).

on:
  pull_request:
    types: [opened, reopened, synchronize]
    paths:
      - "packages/flashtype/**"
      - ".github/workflows/flashtype-preview.yml"

permissions:
  contents: read
  pull-requests: write

jobs:
  upload-preview:
    name: Upload Worker Preview
    runs-on: ubuntu-latest
    environment: flashtype-preview
    env:
      PR_ALIAS: pr-${{ github.event.number }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pnpm
        uses: pnpm/action-setup@v4

      - name: Set up Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Upload preview Worker
        id: wrangler
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: packages/flashtype
          command: versions upload --preview-alias ${{ env.PR_ALIAS }}
          packageManager: pnpm

      - name: Comment preview link
        if: success()
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.number }}
          body: |
            <!-- flashtype-preview -->
            ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
            ┃ 🚀 Flashtype Preview            ┃
            ┃                                  ┃
            ┃ • Alias   : `pr-${{ github.event.number }}`
            ┃ • Preview : ${{ steps.wrangler.outputs.deployment-url || 'Check Wrangler logs for URL' }}
            ┃                                  ┃
            ┃ _(push to refresh)_ ┃
            ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
          body-include: "<!-- flashtype-preview -->"
          edit-mode: replace
